#!/bin/env deno

async function main() {
    const lang = "en";
    const command = new Deno.Command("git", { cwd: Deno.cwd(), args: ["log", "--pretty=format:'%ci'", "-1"] });
    const result = await command.output();
    const stdout = new TextDecoder().decode(result.stdout).toString().trim();
    const date = new Date(stdout);

    const units: Array<{ alias: Intl.RelativeTimeFormatUnit; cut: number }> = [
        { alias: "milisecond", cut: 0.1 },
        { alias: "second", cut: 1 },
        { alias: "minute", cut: 60 },
        { alias: "hour", cut: 3600 },
        { alias: "day", cut: 86400 },
        { alias: "week", cut: 604800 },
        { alias: "year", cut: 31556952 },
    ];

    function getRelativeTimeString(lang: string, date: Date): string {
        const timeMs = date.getTime();
        const deltaSeconds = Math.round((timeMs - Date.now()) / 1000);
        const test = units.findIndex((x) => x.cut > Math.abs(deltaSeconds))
        const unit = test === -1 ? units[0]! : units[test - 1]!
        const rtf = new Intl.RelativeTimeFormat(lang, {
            style: "long",
            numeric: "auto",
            localeMatcher: "best fit",
        });
        return rtf.format(Math.ceil(deltaSeconds / unit.cut), unit.alias);
    }

    return (getRelativeTimeString(lang, date).replace(/ +ago/g, ""));
}

main().then((x) => console.log(x));
